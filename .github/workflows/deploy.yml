name: Deploy on main

on:
  workflow_dispatch:        # Actions 화면에 Run workflow 버튼 표시
  push:
    branches: [ "main" ]    # main에 머지되면 자동 실행

jobs:
  deploy:
    runs-on: [self-hosted, Windows, X64]   # 러너 라벨과 일치

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Print context (sanity check)
        shell: pwsh
        run: |
          hostname
          $PSVersionTable.PSVersion
          docker --version
          docker compose version

      - name: Deploy via Docker Compose (if present)
        if: ${{ hashFiles('**/docker-compose.yml') != '' }}
        shell: pwsh
        run: |
          # 프로젝트 루트에 docker-compose.yml이 있을 때만 실행
          docker compose pull 2>$null
          docker compose up -d

      - name: Slack notify
        if: always() && env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          JOB_STATUS: ${{ job.status }}
        shell: pwsh
        run: |
          $payload = @{ text = "Deploy $env:JOB_STATUS on $env:GITHUB_REPOSITORY@$env:GITHUB_SHA" } | ConvertTo-Json
          Invoke-RestMethod -Uri $env:SLACK_WEBHOOK_URL -Method Post -ContentType 'application/json' -Body $payload
